class P{nextId=1;entities=new Map;componentIndices=new Map;createEntity(){let f=this.nextId++,E={id:f,components:{}};return this.entities.set(f,E),E}addComponent(f,E,j){let K=typeof f==="number"?this.entities.get(f):f;if(!K)throw new Error(`Entity ${f} does not exist`);if(K.components[E]=j,!this.componentIndices.has(E))this.componentIndices.set(E,new Set);return this.componentIndices.get(E)?.add(K.id),this}removeComponent(f,E){let j=this.entities.get(f);if(!j)throw new Error(`Entity ${f} does not exist`);delete j.components[E],this.componentIndices.get(E)?.delete(f)}getComponent(f,E){let j=this.entities.get(f);if(!j)throw new Error(`Entity ${f} does not exist`);return j.components[E]||null}getEntitiesWithComponents(f=[],E=[]){if(f.length===0){if(E.length===0)return Array.from(this.entities.values());return Array.from(this.entities.values()).filter((F)=>{return E.every((J)=>!(J in F.components))})}let j=f.reduce((F,J)=>{let L=this.componentIndices.get(J),V=L?L.size:0,Y=this.componentIndices.get(F)?.size??1/0;return V<Y?J:F},f[0]);return Array.from(this.componentIndices.get(j)||[]).filter((F)=>{let J=this.entities.get(F);return J&&f.every((L)=>(L in J.components))&&E.every((L)=>!(L in J.components))}).map((F)=>this.entities.get(F))}removeEntity(f){let E=this.entities.get(f);if(!E)return!1;for(let j of Object.keys(E.components))this.componentIndices.get(j)?.delete(f);return this.entities.delete(f)}getEntity(f){return this.entities.get(f)}}class Q{handlers=new Map;subscribe(f,E){return this.addHandler(f,E,!1)}once(f,E){return this.addHandler(f,E,!0)}addHandler(f,E,j){if(!this.handlers.has(f))this.handlers.set(f,[]);let K={callback:E,once:j};return this.handlers.get(f).push(K),()=>{let F=this.handlers.get(f);if(F){let J=F.indexOf(K);if(J!==-1)F.splice(J,1)}}}publish(f,E=void 0){let j=this.handlers.get(f);if(!j)return;let K=[...j],F=[];for(let J of K)if(J.callback(E),J.once)F.push(J);if(F.length>0)for(let J of F){let L=j.indexOf(J);if(L!==-1)j.splice(L,1)}}clear(){this.handlers.clear()}clearEvent(f){this.handlers.delete(f)}}class U{resources=new Map;add(f,E){return this.resources.set(f,E),E}get(f){let E=this.resources.get(f);if(E===void 0)throw new Error(`Resource ${String(f)} not found`);return E}getOptional(f){return this.resources.get(f)}has(f){return this.resources.has(f)}remove(f){return this.resources.delete(f)}getKeys(){return Array.from(this.resources.keys())}}var Z="0.0.0";class W{static VERSION=Z;_entityManager;_systems=[];_eventBus;_resourceManager;_installedBundles=new Set;constructor(){this._entityManager=new P,this._eventBus=new Q,this._resourceManager=new U}install(...f){for(let E of f){if(this._installedBundles.has(E.id)){console.warn(`Bundle ${E.id} is already installed`);continue}let j=E.getSystems();if(!j.length)console.warn(`Bundle ${E.id} has no systems`);for(let F of j){let J=F;if(this._systems.push(J),J.onAttach)J.onAttach(this._entityManager,this._resourceManager,this._eventBus);if(J.eventHandlers)for(let L in J.eventHandlers){let V=J.eventHandlers[L];if(V?.handler){let Y=(_)=>{V.handler(_,this._entityManager,this._resourceManager,this._eventBus)};this._eventBus.subscribe(L,Y)}}}let K=E.getResources();for(let[F,J]of K.entries())this._resourceManager.add(F,J);this._installedBundles.add(E.id)}return this}removeSystem(f){let E=this._systems.findIndex((K)=>K.label===f);if(E===-1)return!1;let j=this._systems[E];if(!j)return!1;return j.onDetach?.(this._entityManager,this._resourceManager,this._eventBus),this._systems.splice(E,1),!0}hasResource(f){return this._resourceManager.has(f)}getResource(f){return this._resourceManager.getOptional(f)}getResourceOrThrow(f){return this._resourceManager.get(f)}addResource(f,E){return this._resourceManager.add(f,E),this}hasComponent(f,E){return this._entityManager.getComponent(f,E)!==null}getEntitiesWithComponents(f,E=[]){return this._entityManager.getEntitiesWithComponents(f,E)}update(f){for(let E of this._systems){if(!E.process)continue;let j={};if(E.entityQueries){for(let K in E.entityQueries){let F=E.entityQueries[K];if(F)j[K]=this._entityManager.getEntitiesWithComponents(F.with,F.without||[])}E.process(j,f,this._entityManager,this._resourceManager,this._eventBus)}else E.process([],f,this._entityManager,this._resourceManager,this._eventBus)}}get entityManager(){return this._entityManager}get eventBus(){return this._eventBus}get resourceManager(){return this._resourceManager}get installedBundles(){return Array.from(this._installedBundles)}}function D(){return`bundle_${Date.now().toString(36)}_${Math.random().toString(36).substring(2,9)}`}class M{_systems=[];_resources=new Map;_id;constructor(f){this._id=f||D()}get id(){return this._id}set id(f){this._id=f}addSystem(f){let E=new X(f,this);return this._systems.push(E),E}addResource(f,E){return this._resources.set(f,E),this}getSystems(){return this._systems.map((f)=>f.build())}getResources(){return new Map(this._resources)}getResource(f){return this._resources.get(f)}getSystemBuilders(){return[...this._systems]}hasResource(f){return this._resources.has(f)}}function H(f,...E){if(E.length===0)return new M(f);let j=new M(f);for(let K of E){for(let F of K.getSystemBuilders())j.addSystem(F);for(let[F,J]of K.getResources().entries())j.addResource(F,J)}return j}class X{_label;_bundle;queries={};processFunction;attachFunction;detachFunction;eventHandlers;constructor(f,E=new M){this._label=f;this._bundle=E}get label(){return this._label}get bundle(){return this._bundle}addQuery(f,E){let j=this;return j.queries={...this.queries,[f]:E},j}setProcess(f){return this.processFunction=f,this}setOnAttach(f){return this.attachFunction=f,this}setOnDetach(f){return this.detachFunction=f,this}setEventHandlers(f){return this.eventHandlers=f,this}build(){let f={label:this._label,entityQueries:this.queries};if(this.processFunction)f.process=this.processFunction;if(this.attachFunction)f.onAttach=this.attachFunction;if(this.detachFunction)f.onDetach=this.detachFunction;if(this.eventHandlers)f.eventHandlers=this.eventHandlers;return f}}var c=W;export{H as mergeBundles,c as default,X as SystemBuilder,U as ResourceManager,Q as EventBus,P as EntityManager,M as Bundle};

//# debugId=E99280FFA99FE54364756E2164756E21
//# sourceMappingURL=index.js.map
